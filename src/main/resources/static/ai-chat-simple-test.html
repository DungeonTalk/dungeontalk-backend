<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì±„íŒ… ê°„ë‹¨ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        input, textarea, button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        input[type="text"], textarea {
            width: 300px;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            min-width: 100px;
            margin-left: 10px;
        }
        
        button:hover {
            background: #5a6fd8;
        }
        
        .response {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            min-height: 20px;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d2e;
            border: 1px solid #c3e6c3;
        }
        
        .error {
            background: #ffeaea;
            color: #d32f2f;
            border: 1px solid #ffcdd2;
        }
        
        .info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ² AI ì±„íŒ… ê°„ë‹¨ í…ŒìŠ¤íŠ¸</h1>
            <p>WebSocket ì—†ì´ API ì§ì ‘ í˜¸ì¶œë¡œ í…ŒìŠ¤íŠ¸</p>
        </div>
        
        <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
        <div class="section">
            <h3>1. ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</h3>
            <div class="form-group">
                <label>ì‚¬ìš©ì ID:</label>
                <input type="text" id="loginId" value="testuser1" />
                <button onclick="register()">íšŒì›ê°€ì…</button>
                <button onclick="login()">ë¡œê·¸ì¸</button>
            </div>
            <div class="form-group">
                <label>ë¹„ë°€ë²ˆí˜¸:</label>
                <input type="password" id="loginPassword" value="password123" />
            </div>
            <div id="loginResponse" class="response"></div>
        </div>
        
        <!-- AI ê²Œì„ë°© ì„¹ì…˜ -->
        <div class="section">
            <h3>2. AI ê²Œì„ë°© í…ŒìŠ¤íŠ¸</h3>
            <div class="form-group">
                <label>ê²Œì„ ID:</label>
                <input type="text" id="gameId" value="test-game-001" />
                <button onclick="createAiRoom()">ë°© ìƒì„±</button>
            </div>
            <div class="form-group">
                <label>ë°© ì´ë¦„:</label>
                <input type="text" id="roomName" value="í…ŒìŠ¤íŠ¸ AI ë°©" />
            </div>
            <div class="form-group">
                <label>ìƒì„±ëœ ë°© ID:</label>
                <input type="text" id="roomId" readonly />
                <button onclick="getRoomInfo()">ë°© ì •ë³´ ì¡°íšŒ</button>
            </div>
            <div id="roomResponse" class="response"></div>
        </div>
        
        <!-- AI ì‘ë‹µ í…ŒìŠ¤íŠ¸ ì„¹ì…˜ -->
        <div class="section">
            <h3>3. AI ì‘ë‹µ ìƒì„± í…ŒìŠ¤íŠ¸</h3>
            <div class="form-group">
                <label>í˜„ì¬ ì‚¬ìš©ì:</label>
                <input type="text" id="currentUser" value="í…ŒìŠ¤í„°1" />
            </div>
            <div class="form-group">
                <label>ë©”ì‹œì§€:</label>
                <textarea id="userMessage" rows="3">ì•ˆë…•í•˜ì„¸ìš”! ìƒˆë¡œìš´ ë˜ì „ íƒí—˜ì„ ì‹œì‘í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤.</textarea>
            </div>
            <div class="form-group">
                <label>í„´ ë²ˆí˜¸:</label>
                <input type="number" id="turnNumber" value="1" min="1" />
                <button onclick="generateAiResponse()">AI ì‘ë‹µ ìƒì„±</button>
            </div>
            <div id="aiResponse" class="response"></div>
        </div>
        
        <!-- AI ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ -->
        <div class="section">
            <h3>4. AI ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸</h3>
            <div class="form-group">
                <button onclick="checkAiService()">Python AI ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸</button>
                <button onclick="testAiDirectly()">Python AI ì§ì ‘ í…ŒìŠ¤íŠ¸</button>
            </div>
            <div id="aiServiceResponse" class="response"></div>
        </div>
        
        <!-- í† í° ì •ë³´ -->
        <div class="section">
            <h3>5. í˜„ì¬ ì¸ì¦ ìƒíƒœ</h3>
            <div class="form-group">
                <button onclick="showTokenInfo()">í† í° ì •ë³´ ë³´ê¸°</button>
                <button onclick="clearTokens()">í† í° ì‚­ì œ</button>
            </div>
            <div id="tokenInfo" class="response"></div>
        </div>
    </div>

    <script>
        // ê³µí†µ í•¨ìˆ˜ë“¤
        function getAuthHeaders() {
            const token = localStorage.getItem('authToken');
            return token ? { 'Authorization': 'Bearer ' + token } : {};
        }
        
        function showResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.className = 'response ' + (isError ? 'error' : 'success');
            
            if (typeof data === 'object') {
                element.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
            } else {
                element.innerHTML = data;
            }
        }
        
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.className = 'response error';
            element.innerHTML = message;
        }
        
        // 1. íšŒì›ê°€ì…
        async function register() {
            const id = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!id || !password) {
                showError('loginResponse', 'ì‚¬ìš©ì IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch('/v1/member/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: id,
                        nickName: id + 'ë‹˜',
                        password: password
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResponse('loginResponse', 'íšŒì›ê°€ì… ì„±ê³µ: ' + JSON.stringify(data));
                } else {
                    const error = await response.text();
                    showError('loginResponse', 'íšŒì›ê°€ì… ì‹¤íŒ¨: ' + error);
                }
            } catch (error) {
                showError('loginResponse', 'íšŒì›ê°€ì… ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // 2. ë¡œê·¸ì¸
        async function login() {
            const id = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!id || !password) {
                showError('loginResponse', 'ì‚¬ìš©ì IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch('/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: id,
                        password: password
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // JWT í† í° ì €ì¥
                    localStorage.setItem('authToken', data.accessToken);
                    localStorage.setItem('currentUser', JSON.stringify({
                        id: data.memberId,
                        nickname: data.memberNickName || id + 'ë‹˜'
                    }));
                    
                    showResponse('loginResponse', 'ë¡œê·¸ì¸ ì„±ê³µ: ' + JSON.stringify(data));
                    document.getElementById('currentUser').value = data.memberNickName || id + 'ë‹˜';
                } else {
                    const error = await response.text();
                    showError('loginResponse', 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error);
                }
            } catch (error) {
                showError('loginResponse', 'ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // 3. AI ê²Œì„ë°© ìƒì„±
        async function createAiRoom() {
            const gameId = document.getElementById('gameId').value;
            const roomName = document.getElementById('roomName').value;
            
            if (!gameId || !roomName) {
                showError('roomResponse', 'ê²Œì„ IDì™€ ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (!currentUser.id) {
                showError('roomResponse', 'ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch('/api/v1/aichat/rooms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        gameId: gameId,
                        roomName: roomName,
                        description: 'í…ŒìŠ¤íŠ¸ìš© AI ê²Œì„ë°©',
                        maxParticipants: 3,
                        creatorId: currentUser.id
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('roomId').value = data.id;
                    showResponse('roomResponse', 'ë°© ìƒì„± ì„±ê³µ: ' + JSON.stringify(data));
                } else {
                    const error = await response.text();
                    showError('roomResponse', 'ë°© ìƒì„± ì‹¤íŒ¨: ' + error);
                }
            } catch (error) {
                showError('roomResponse', 'ë°© ìƒì„± ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // 4. ë°© ì •ë³´ ì¡°íšŒ
        async function getRoomInfo() {
            const roomId = document.getElementById('roomId').value;
            
            if (!roomId) {
                showError('roomResponse', 'ë°© IDë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë¨¼ì € ë°©ì„ ìƒì„±í•˜ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/aichat/rooms/${roomId}`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResponse('roomResponse', 'ë°© ì •ë³´: ' + JSON.stringify(data));
                } else {
                    const error = await response.text();
                    showError('roomResponse', 'ë°© ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: ' + error);
                }
            } catch (error) {
                showError('roomResponse', 'ë°© ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // 5. AI ì‘ë‹µ ìƒì„±
        async function generateAiResponse() {
            const roomId = document.getElementById('roomId').value;
            const gameId = document.getElementById('gameId').value;
            const currentUser = document.getElementById('currentUser').value;
            const message = document.getElementById('userMessage').value;
            const turnNumber = parseInt(document.getElementById('turnNumber').value);
            
            if (!roomId || !gameId || !currentUser || !message) {
                showError('aiResponse', 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ë°© ID, ê²Œì„ ID, ì‚¬ìš©ì, ë©”ì‹œì§€)');
                return;
            }
            
            try {
                showResponse('aiResponse', 'AI ì‘ë‹µ ìƒì„± ì¤‘...', false);
                
                const response = await fetch(`/api/v1/aichat/ai-service/rooms/${roomId}/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        gameId: gameId,
                        currentUser: currentUser,
                        currentMessage: message,
                        turnNumber: turnNumber
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResponse('aiResponse', 'AI ì‘ë‹µ ìƒì„± ì„±ê³µ: ' + JSON.stringify(data));
                    // í„´ ë²ˆí˜¸ ì¦ê°€
                    document.getElementById('turnNumber').value = turnNumber + 1;
                } else {
                    const error = await response.text();
                    showError('aiResponse', 'AI ì‘ë‹µ ìƒì„± ì‹¤íŒ¨: ' + error);
                }
            } catch (error) {
                showError('aiResponse', 'AI ì‘ë‹µ ìƒì„± ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // 6. AI ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
        async function checkAiService() {
            try {
                const response = await fetch('http://localhost:8001/health');
                
                if (response.ok) {
                    const data = await response.json();
                    showResponse('aiServiceResponse', 'AI ì„œë¹„ìŠ¤ ìƒíƒœ: ' + JSON.stringify(data));
                } else {
                    showError('aiServiceResponse', 'AI ì„œë¹„ìŠ¤ ì—°ê²° ì‹¤íŒ¨: ' + response.statusText);
                }
            } catch (error) {
                showError('aiServiceResponse', 'AI ì„œë¹„ìŠ¤ í™•ì¸ ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // 7. Python AI ì§ì ‘ í…ŒìŠ¤íŠ¸
        async function testAiDirectly() {
            try {
                const response = await fetch('http://localhost:8001/ai-response', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        game_id: "test-game-001",
                        ai_game_room_id: "test-room-001",
                        current_user: "í…ŒìŠ¤í„°",
                        current_message: "ì•ˆë…•í•˜ì„¸ìš”! ìƒˆë¡œìš´ ë˜ì „ì„ íƒí—˜í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤.",
                        context_messages: [],
                        turn_number: 1
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResponse('aiServiceResponse', 'Python AI ì§ì ‘ ì‘ë‹µ: ' + JSON.stringify(data));
                } else {
                    const error = await response.text();
                    showError('aiServiceResponse', 'Python AI ì§ì ‘ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error);
                }
            } catch (error) {
                showError('aiServiceResponse', 'Python AI ì§ì ‘ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // 8. í† í° ì •ë³´ í‘œì‹œ
        function showTokenInfo() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('currentUser');
            
            if (token && user) {
                const tokenInfo = {
                    token: token.substring(0, 50) + '...',
                    user: JSON.parse(user),
                    tokenLength: token.length
                };
                showResponse('tokenInfo', 'í˜„ì¬ ì¸ì¦ ì •ë³´: ' + JSON.stringify(tokenInfo));
            } else {
                showError('tokenInfo', 'ì €ì¥ëœ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            }
        }
        
        // 9. í† í° ì‚­ì œ
        function clearTokens() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            showResponse('tokenInfo', 'í† í°ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('currentUser');
            
            if (token && user) {
                const userData = JSON.parse(user);
                document.getElementById('currentUser').value = userData.nickname || userData.id + 'ë‹˜';
                showResponse('tokenInfo', `ê¸°ì¡´ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ë¨: ${userData.nickname}`);
            }
        });
    </script>
</body>
</html>